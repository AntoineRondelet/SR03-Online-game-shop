function initEvents(){var e=document.getElementsByClassName("filters")[0].getElementsByTagName("button")[0];e.addEventListener("click",function(e){e.preventDefault(),window.location.hash="#"});var t=document.getElementsByClassName("single-game")[0];t.addEventListener("click",function(e){if(t.classList.contains("visible")){var a=e.target;(a.classList.contains("close")||a.classList.contains("overlay"))&&createQueryHash(filters)}});var a=document.getElementsByClassName("cart")[0];a.addEventListener("click",function(e){if(a.classList.contains("visible")){var t=e.target;(t.classList.contains("close")||t.classList.contains("overlay"))&&createQueryHash(filters)}});var n=document.getElementsByClassName("logout")[0];n.addEventListener("click",function(e){if(n.classList.contains("visible")){var t=e.target;(t.classList.contains("close")||t.classList.contains("overlay"))&&(window.location.hash="#")}});var s=document.getElementById("logout-button");s.addEventListener("click",function(e){e.preventDefault(),window.location.hash="#logout"});var r=document.getElementById("cart-button");r.addEventListener("click",function(e){e.preventDefault(),window.location.hash="#cart"});var o=document.getElementById("pay-button");o.addEventListener("click",function(e){e.preventDefault(),validateCart(),window.location.hash="#"})}function initFilters(){initPagination(),initFilterCheckboxes()}function initPagination(){var e=document.querySelectorAll(".pageNumber li");e.forEach(function(e){e.addEventListener("click",function(t){var a="page";filters[a]&&filters[a].length?filters[a].length=0:filters[a]=[];var n=e.innerHTML,s=parseInt(document.getElementById("currentPage").innerHTML);n="«"==n?s>1?s-1:s:"»"==n&&lastPage>s?s+1:s,filters[a].push(n),createQueryHash(filters)})});var t=document.querySelectorAll(".itemsPerPage li");t.forEach(function(e){e.addEventListener("click",function(t){var a="itemsPerPage";filters[a]&&filters[a].length?filters[a].length=0:filters[a]=[],filters[a].push(e.innerHTML),createQueryHash(filters)})})}function initFilterCheckboxes(){var e=document.querySelectorAll('.filter-criteria input[type="checkbox"]');e.forEach(function(e){e.addEventListener("click",function(t){var a=e.getAttribute("name");if(e.checked)filters[a]&&filters[a].length||(filters[a]=[]),filters[a].push(e.value);else if(filters[a]&&filters[a].length&&-1!=filters[a].indexOf(e.value)){var n=filters[a].indexOf(e.value);filters[a].splice(n,1),filters[a].length||delete filters[a]}createQueryHash(filters)})})}function dropCart(){var e=sessionStorage.getItem("token"),t="-1";if(sessionStorage.getItem("cartId")){t=sessionStorage.getItem("cartId");var a=new XMLHttpRequest;a.open("GET","http://localhost:8080/gameshop_war_exploded/api/cart/drop/"+t,!0),a.setRequestHeader("Authorization","Bearer "+e),a.setRequestHeader("Content-Type","application/json"),a.onreadystatechange=function(){return a.readyState==XMLHttpRequest.DONE&&200!=a.status&&206!=a.status?void(401==a.status?window.location.hash="#login":alert("Oops ! Something went wrong :(")):void 0},a.send()}}function validateCart(){var e=sessionStorage.getItem("token"),t="-1";sessionStorage.getItem("cartId")&&(t=sessionStorage.getItem("cartId"));var a=new XMLHttpRequest;a.open("GET","http://localhost:8080/gameshop_war_exploded/api/cart/validate/"+t,!0),a.setRequestHeader("Authorization","Bearer "+e),a.setRequestHeader("Content-Type","application/json"),a.onreadystatechange=function(){if(a.readyState==XMLHttpRequest.DONE){if(200!=a.status&&206!=a.status)return void(401==a.status?window.location.hash="#login":alert("Oops ! Something went wrong :("));var e=JSON.parse(a.responseText);alert(e.message),sessionStorage.getItem("cartId")&&sessionStorage.removeItem("cartId");for(var t=document.getElementsByClassName("cart-games-list")[0];t.firstChild;)t.removeChild(t.firstChild);setPayButtonValue()}},a.send()}function buyAGame(e){var t=sessionStorage.getItem("token"),a="-1";sessionStorage.getItem("cartId")&&(a=sessionStorage.getItem("cartId"));var n=new XMLHttpRequest;n.open("PUT","http://localhost:8080/gameshop_war_exploded/api/purchases",!0),n.setRequestHeader("Authorization","Bearer "+t),n.setRequestHeader("Content-Type","application/json"),n.onreadystatechange=function(){if(n.readyState==XMLHttpRequest.DONE){if(200!=n.status&&206!=n.status)return void(401==n.status?window.location.hash="#login":alert("Oops ! Something went wrong :("));var e=JSON.parse(n.responseText);sessionStorage.setItem("cartId",e.cart),alert(e.message)}},n.send(JSON.stringify({cart:a,game:e,action:"add"}))}function deleteAGame(e){var t=sessionStorage.getItem("token"),a="-1";sessionStorage.getItem("cartId")&&(a=sessionStorage.getItem("cartId"));var n=new XMLHttpRequest;n.open("PUT","http://localhost:8080/gameshop_war_exploded/api/purchases",!0),n.setRequestHeader("Authorization","Bearer "+t),n.setRequestHeader("Content-Type","application/json"),n.onreadystatechange=function(){if(n.readyState==XMLHttpRequest.DONE){if(200!=n.status&&206!=n.status)return void(401==n.status?window.location.hash="#login":alert("Oops ! Something went wrong :("));var e=JSON.parse(n.responseText);sessionStorage.setItem("cartId",e.cart),alert(e.message)}},n.send(JSON.stringify({cart:a,game:e,action:"delete"}))}function cleanFilters(){var e=document.querySelectorAll('.filter-criteria input[type="checkbox"]');e.forEach(function(e){e.checked=!1})}function calculateCartPrice(e){var t=0;return e.games.forEach(function(e){var a=parseInt(e.game_price),n=parseInt(e.instances.length);t+=a*n}),t}function setCartButtonValue(e){var t=document.getElementById("cart-button");t.innerHTML="Cart ("+e+"$)"}function setPayButtonValue(e){e=e||"0";var t=document.getElementById("pay-button");t.innerHTML="Pay ("+e+"$)"}function renderCartPage(){var e=sessionStorage.getItem("token"),t="-1";if(!sessionStorage.getItem("cartId")){var a=document.getElementsByClassName("cart")[0];return void a.classList.add("visible")}for(var n=document.getElementsByClassName("cart-games-list")[0];n.firstChild;)n.removeChild(n.firstChild);t=sessionStorage.getItem("cartId");var s=new XMLHttpRequest;s.open("GET","http://localhost:8080/gameshop_war_exploded/api/purchases/"+t,!0),s.setRequestHeader("Authorization","Bearer "+e),s.onreadystatechange=function(){if(s.readyState==XMLHttpRequest.DONE){if(200!=s.status&&206!=s.status)return void(401==s.status?window.location.hash="#login":alert("Oops HER ! Something went wrong :("));if(""==s.responseText)return;var e=JSON.parse(s.responseText),t=calculateCartPrice(e);setPayButtonValue(t),e.games.forEach(function(e){var t=document.getElementById("cart-games-template").innerHTML;for(var a in e)t=t.replace(new RegExp("{{"+a+"}}","g"),e[a]);t=t.replace(new RegExp("{{entities}}","g"),e.instances.length),t=t.replace(new RegExp("{{price}}","g"),e.instances.length*e.game_price);var n=document.createElement("li");n.innerHTML=t;var s=n.getElementsByTagName("button")[0];s.addEventListener("click",function(e){var t=s.getAttribute("data-index");deleteAGame(t),renderCartPage()}),document.getElementsByClassName("cart-games-list")[0].appendChild(n)})}var a=document.getElementsByClassName("cart")[0];a.classList.add("visible")},s.send()}function renderGames(e){var t=sessionStorage.getItem("token");e=e||"";for(var a=document.getElementsByClassName("games-list")[0];a.firstChild;)a.removeChild(a.firstChild);var n=new XMLHttpRequest;n.open("GET","http://localhost:8080/gameshop_war_exploded/api/games"+e,!0),n.setRequestHeader("Authorization","Bearer "+t),n.onreadystatechange=function(){if(n.readyState==XMLHttpRequest.DONE){if(200!=n.status&&206!=n.status)return void(401==n.status?window.location.hash="#login":alert("Oops ! Something went wrong :("));var e=JSON.parse(n.responseText);lastPage=e.pagination.pages.last,pageNumber=e.pagination.current_page,document.getElementById("currentPage").innerHTML=pageNumber,e.list.forEach(function(e){var t=document.getElementById("games-template").innerHTML;for(var a in e)t=t.replace(new RegExp("{{"+a+"}}","g"),e[a]);t=t.replace(new RegExp("{{rate-percent}}","g"),e.rate/5*100);var n="";e.keywords.forEach(function(e){n=n+" "+e.word}),t=t.replace(new RegExp("{{type}}","g"),n),t=t.replace(new RegExp("{{image}}","g"),"assets/images/list/"+e.id+".jpg");var s=document.createElement("li");s.innerHTML=t,e.stock<=0&&s.classList.add("hidden"),s.addEventListener("click",function(t){var a=t.target;if(a.classList.contains("buy")){var n=s.getElementsByClassName("game")[0].getAttribute("data-index");buyAGame(n)}else t.preventDefault(),window.location.hash="game/"+e.id}),document.getElementsByClassName("games-list")[0].appendChild(s)})}document.getElementsByClassName("all-games")[0].classList.add("visible")},n.send()}function renderLoginPage(){var e=document.getElementsByClassName("login")[0];e.classList.add("visible");var t=document.forms.namedItem("login-form");t.addEventListener("submit",function(e){var t=document.querySelectorAll("input[type=text]")[0].value,a=document.querySelectorAll("input[type=password]")[0].value;xhr=new XMLHttpRequest,xhr.open("POST","http://localhost:8080/gameshop_war_exploded/api/login"),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.onreadystatechange=function(){if(xhr.readyState==XMLHttpRequest.DONE){if(200!=xhr.status)return 401==xhr.status?void(document.getElementById("message-login").innerHTML="Bad credentials"):void(document.getElementById("message-login").innerHTML="Something went wrong; try again (error code "+xhr.status+")");var e=JSON.parse(xhr.responseText),t=e.token;sessionStorage.setItem("token",t),window.location.hash="#"}};var n="username="+t+"&password="+a;xhr.send(encodeURI(n)),e.preventDefault()})}function renderErrorPage(){var e=document.getElementsByClassName("error")[0];e.classList.add("visible")}function renderSingleGamePage(e){var t=sessionStorage.getItem("token"),a=new XMLHttpRequest;a.open("GET","http://localhost:8080/gameshop_war_exploded/api/games/"+e,!0),a.setRequestHeader("Authorization","Bearer "+t),a.onreadystatechange=function(){if(a.readyState==XMLHttpRequest.DONE){if(200!=a.status&&206!=a.status)return void(401==a.status?window.location.hash="#login":alert("Oops ! Something went wrong :("));var e=JSON.parse(a.responseText),t=document.getElementsByClassName("single-game")[0];t.getElementsByTagName("h3")[0].innerHTML=e.title,t.getElementsByTagName("img")[0].setAttribute("src","assets/images/preview/"+e.id+".jpg"),t.getElementsByTagName("p")[0].innerHTML=e.description}document.getElementsByClassName("single-game")[0].classList.add("visible")},a.send()}function render(e){for(var t=e.split("/")[0],a=document.getElementsByClassName("page"),n=0,s=a.length;s>n;n++)a[n].classList.remove("visible");document.getElementsByClassName("main-content")[0].classList.remove("visible");var r={"":function(){console.log("Rendering home page"),filters={},cleanFilters(),renderGames()},"#game":function(){console.log("Rendering single game page");var t=e.split("#game/")[1].trim();renderSingleGamePage(t)},"#login":function(){console.log("Rendering login page"),renderLoginPage()},"#logout":function(){console.log("Rendering logout page"),dropCart(),sessionStorage.getItem("cartId")&&sessionStorage.removeItem("cartId"),renderLogoutPage()},"#cart":function(){console.log("Rendering cart page"),renderCartPage()},"#filter":function(){e=e.split("#filter/")[1].trim();try{filters=JSON.parse(e)}catch(t){return void(window.location.hash="#")}renderFilterResults(filters)}};r[t]?r[t]():renderErrorPage()}function createQueryHash(e){0!==Object.keys(e).length||e.constructor!==Object?window.location.hash="#filter/"+JSON.stringify(e):window.location.hash="#"}function renderFilterResults(e){for(var t="?",a=[],n=Object.keys(e),s=0;s<n.length;s++)for(var r=n[s],o=e[r],i=0;i<o.length;i++){var l=o[i];a.push(r+"="+l)}t+=a.join("&"),renderGames(t)}function renderLogoutPage(){var e=sessionStorage.getItem("token"),t=new XMLHttpRequest;t.open("GET","http://localhost:8080/gameshop_war_exploded/api/logout",!0),t.setRequestHeader("Authorization","Bearer "+e),t.onreadystatechange=function(){if(t.readyState==XMLHttpRequest.DONE&&200!=t.status&&206!=t.status)return void(401==t.status?window.location.hash="#login":alert("Oops HER ! Something went wrong. Could not logged out. Please close your windows and you session will be destroyed."));var e=document.getElementsByClassName("logout")[0];e.classList.add("visible")},t.send()}var filters={},pageNumber=1,lastPage=100,itemsPerPage=10;document.addEventListener("DOMContentLoaded",function(){initFilters(),window.onhashchange=function(){render(decodeURI(window.location.hash))},sessionStorage.getItem("token")?renderGames():window.location.hash="#login",initEvents()});